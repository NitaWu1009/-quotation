<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>報價單產生器</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { font-size: 0.95rem; } 
        input, textarea { font-size: 0.9rem; }
        
        /* 備註欄 CSS */
        #quoteNote { 
            font-size: 0.85rem; 
            line-height: 1.5; 
            overflow-y: hidden; 
            resize: none;      
            min-height: 120px;  
            width: 100%;
            display: block;
        }

        @media print {
            @page {
                size: A4;
                margin: 0.8cm; /* 適度增加邊距 */
            }
            html, body {
                zoom: 92%; /* 調整為 92% */
                height: auto; 
            }
            .no-print { display: none !important; }
            body { padding: 0; background: white; }
            .shadow-lg { box-shadow: none !important; border: 1px solid #eee; }
            #invoice {
                border: none !important;
                margin: 0 !important;
                padding: 10px !important;
            }
            #quoteNote {
                overflow: hidden !important;
                height: auto !important;
            }
        }
    </style>
</head>
<body class="bg-gray-100 p-4 md:p-6">

    <div class="max-w-4xl mx-auto bg-white p-8 shadow-lg rounded-lg border border-gray-200" id="invoice">
        <div class="flex justify-between items-start border-b-4 border-gray-800 pb-4 mb-6">
            <div>
                <h1 class="text-4xl font-extrabold text-gray-800">報價單</h1>
                <h2 class="text-xl font-bold text-blue-600 mt-1">大腦行銷</h2>
            </div>
            <div class="text-right space-y-1 text-sm">
                <p class="text-gray-600">報價日期：<input type="date" id="currentDate" class="outline-none border-b border-gray-200 focus:border-blue-400"></p>
                <p class="text-gray-600">報價編號：<input type="text" id="quoteId" placeholder="QT-20260204" class="outline-none text-right border-b border-gray-200 focus:border-blue-400 w-32"></p>
            </div>
        </div>

        <div class="mb-6">
            <h3 class="font-bold text-gray-700 mb-2 border-l-4 border-blue-500 pl-2 text-base">客戶資訊</h3>
            <div class="grid grid-cols-2 gap-x-6 gap-y-2 text-sm">
                <div class="flex items-center"><span class="w-20 text-gray-500 flex-shrink-0">公司名稱:</span><input type="text" id="clientName" class="w-full border-b border-gray-300 outline-none px-2" placeholder="客戶全銜"></div>
                <div class="flex items-center"><span class="w-20 text-gray-500 flex-shrink-0">官方網域:</span><input type="text" class="w-full border-b border-gray-300 outline-none px-2"></div>
                <div class="flex items-center"><span class="w-20 text-gray-500 flex-shrink-0">連絡電話:</span><input type="text" class="w-full border-b border-gray-300 outline-none px-2"></div>
                <div class="flex items-center"><span class="w-20 text-gray-500 flex-shrink-0">統一編號:</span><input type="text" class="w-full border-b border-gray-300 outline-none px-2"></div>
            </div>
        </div>

        <table class="w-full mb-4 text-left border-collapse text-sm">
            <thead>
                <tr class="bg-gray-800 text-white">
                    <th class="p-3 rounded-l-md">類別 / 項目</th>
                    <th class="p-3 w-20 text-center">數量</th>
                    <th class="p-3 w-32 text-center">單價</th>
                    <th class="p-3 w-32 text-center">金額</th>
                    <th class="p-3 w-12 no-print"></th>
                </tr>
            </thead>
            <tbody id="item-list">
                <tr class="border-b border-gray-100">
                    <td class="p-2"><input type="text" placeholder="項目說明" class="w-full outline-none bg-transparent"></td>
                    <td class="p-2 text-center"><input type="number" value="1" class="qty w-full text-center outline-none bg-transparent" oninput="calculate()"></td>
                    <td class="p-2 text-center"><input type="number" value="0" class="price w-full text-center outline-none bg-transparent" oninput="calculate()"></td>
                    <td class="p-2 text-center font-bold total-cell">0</td>
                    <td class="p-2 no-print text-right"><button onclick="removeItem(this)" class="text-red-400 font-bold">✕</button></td>
                </tr>
            </tbody>
        </table>
        
        <button type="button" onclick="addItem()" class="no-print mb-4 inline-flex items-center text-blue-600 font-bold text-sm hover:text-blue-800">
            <span class="text-lg mr-1">+</span> 新增報價項目
        </button>

        <div class="flex justify-end mb-6">
            <div class="w-64 space-y-1 border-t-2 border-gray-800 pt-2">
                <div class="flex justify-between items-center">
                    <span class="text-sm text-gray-600">總計金額 (含稅)</span>
                    <span id="grandTotal" class="font-bold text-xl text-blue-700">0</span>
                </div>
            </div>
        </div>

        <div class="mb-6 bg-gray-50 p-4 rounded-lg border-l-4 border-gray-300">
            <h4 class="font-bold text-gray-700 mb-1 text-sm underline">報價備註說明 (Notes)</h4>
            <textarea id="quoteNote" oninput="autoHeight(this)" class="w-full bg-transparent outline-none text-gray-600" placeholder="請輸入備註內容..."></textarea>
        </div>

        <div class="grid grid-cols-2 gap-8">
            <div class="border border-gray-300 rounded p-4 min-h-[100px] flex flex-col justify-between">
                <p class="font-bold text-sm">報價人簽章 (大腦行銷)</p>
                <div class="text-xs text-gray-400 pt-1 border-t border-dashed">日期：2026 / &nbsp;&nbsp;&nbsp; / </div>
            </div>
            <div class="border border-gray-300 rounded p-4 min-h-[100px] flex flex-col justify-between">
                <p class="font-bold text-sm">客戶簽章確認</p>
                <div class="text-xs text-gray-400 pt-1 border-t border-dashed">日期：2026 / &nbsp;&nbsp;&nbsp; / </div>
            </div>
        </div>
    </div>

    <div class="max-w-4xl mx-auto mt-6 flex gap-4 justify-center no-print">
        <button onclick="handlePrint()" class="bg-gray-800 text-white font-bold py-3 px-8 rounded-lg shadow hover:bg-black transition">列印 / PDF</button>
        <button onclick="saveToNotion()" id="saveBtn" class="bg-blue-600 text-white font-bold py-3 px-8 rounded-lg shadow hover:bg-blue-700 transition">儲存至 Notion</button>
    </div>

    <script>
        document.getElementById('currentDate').valueAsDate = new Date();

        function autoHeight(element) {
            element.style.height = "auto";
            element.style.height = (element.scrollHeight) + "px";
        }

        window.onload = function() {
            autoHeight(document.getElementById('quoteNote'));
        };

        // 檔名連動與列印
        function handlePrint() {
            const clientName = document.getElementById('clientName').value || "未命名客戶";
            const date = document.getElementById('currentDate').value;
            const quoteId = document.getElementById('quoteId').value || "無編號";
            
            // 暫時修改網頁標題，這會影響 PDF 預設存檔檔名
            const originalTitle = document.title;
            document.title = `${clientName}-${date}-${quoteId}`;
            
            window.print();
            
            // 印完後改回原標題
            setTimeout(() => { document.title = originalTitle; }, 1000);
        }

        function addItem() {
            const list = document.getElementById('item-list');
            const row = document.createElement('tr');
            row.className = "border-b border-gray-100";
            row.innerHTML = `
                <td class="p-2"><input type="text" placeholder="項目說明" class="w-full outline-none bg-transparent"></td>
                <td class="p-2 text-center"><input type="number" value="1" class="qty w-full text-center outline-none bg-transparent" oninput="calculate()"></td>
                <td class="p-2 text-center"><input type="number" value="0" class="price w-full text-center outline-none bg-transparent" oninput="calculate()"></td>
                <td class="p-2 text-center font-bold total-cell">0</td>
                <td class="p-2 no-print text-right"><button onclick="removeItem(this)" class="text-red-400 font-bold">✕</button></td>
            `;
            list.appendChild(row);
        }

        function removeItem(btn) { btn.closest('tr').remove(); calculate(); }

        function calculate() {
            let subtotal = 0;
            const rows = document.querySelectorAll('#item-list tr');
            rows.forEach(row => {
                const qty = parseFloat(row.querySelector('.qty').value) || 0;
                const price = parseFloat(row.querySelector('.price').value) || 0;
                const total = qty * price;
                row.querySelector('.total-cell').innerText = total.toLocaleString();
                subtotal += total;
            });
            document.getElementById('grandTotal').innerText = Math.round(subtotal * 1.05).toLocaleString();
        }

        async function saveToNotion() {
            const saveBtn = document.getElementById('saveBtn');
            const clientName = document.getElementById('clientName').value;
            if (!clientName) { alert("請輸入客戶公司名稱後再儲存"); return; }
            saveBtn.innerText = "連動中...";
            saveBtn.disabled = true;
            const data = {
                company: clientName,
                date: document.getElementById('currentDate').value,
                total: parseInt(document.getElementById('grandTotal').innerText.replace(/,/g, '')),
                id: document.getElementById('quoteId').value,
                note: document.getElementById('quoteNote').value
            };
            try {
                const response = await fetch("https://eo2ddbgd6zenms9.m.pipedream.net", {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                if (response.ok) alert('✅ 儲存成功！');
                else alert('❌ 儲存失敗');
            } catch (error) {
                alert('❌ 網路連線錯誤');
            } finally {
                saveBtn.innerText = "儲存至 Notion";
                saveBtn.disabled = false;
            }
        }
    </script>
</body>
</html>

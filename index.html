<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>大腦行銷 - 專業報價系統</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/signature_pad@4.1.7/dist/signature_pad.umd.min.js"></script>
    <style>
        body { font-size: 0.95rem; } 
        input, textarea { font-size: 0.9rem; border-radius: 4px; transition: all 0.2s; }
        #quoteNote { font-size: 0.85rem; line-height: 1.5; overflow-y: hidden; resize: none; min-height: 80px; width: 100%; display: block; }
        .signature-wrapper { border: 1px solid #e2e8f0; background-color: #f8fafc; border-radius: 0.375rem; position: relative; width: 100%; height: 120px; }
        canvas { width: 100%; height: 100%; touch-action: none; }
        @media print {
            @page { size: A4; margin: 0.8cm; }
            html, body { zoom: 92%; height: auto; }
            .no-print { display: none !important; }
            body { padding: 0; background: white; }
            .shadow-lg { box-shadow: none !important; border: 1px solid #eee; }
            #invoice { border: none !important; margin: 0 !important; padding: 10px !important; }
            input, textarea { border: none !important; background: transparent !important; }
        }
    </style>
</head>
<body class="bg-gray-100 p-4 md:p-6">

    <div class="max-w-4xl mx-auto bg-white p-8 shadow-lg rounded-lg border border-gray-200" id="invoice">
        <div class="flex justify-between items-start border-b-4 border-gray-800 pb-4 mb-6">
            <div>
                <h1 class="text-4xl font-extrabold text-gray-800">報價單</h1>
                <h2 class="text-xl font-bold text-blue-600 mt-1">大腦行銷</h2>
            </div>
            <div class="text-right space-y-1 text-sm">
                <p class="text-gray-600">報價日期：<input type="date" id="currentDate" class="outline-none border-b border-gray-200"></p>
                <p class="text-gray-600">報價編號：<input type="text" id="quoteId" placeholder="QT-20260204" class="outline-none text-right border-b border-gray-200 w-32"></p>
            </div>
        </div>

        <div class="mb-6">
            <h3 class="font-bold text-gray-700 mb-2 border-l-4 border-blue-500 pl-2 text-base">客戶資訊</h3>
            <div class="grid grid-cols-2 gap-x-6 gap-y-2 text-sm">
                <div class="flex items-center"><span class="w-20 text-gray-500 flex-shrink-0">公司名稱:</span><input type="text" id="clientName" class="w-full border-b border-gray-300 px-2"></div>
                <div class="flex items-center"><span class="w-20 text-gray-500 flex-shrink-0">官方網域:</span><input type="text" id="clientWeb" class="w-full border-b border-gray-300 px-2"></div>
                <div class="flex items-center"><span class="w-20 text-gray-500 flex-shrink-0">連絡電話:</span><input type="text" id="clientPhone" class="w-full border-b border-gray-300 px-2"></div>
                <div class="flex items-center"><span class="w-20 text-gray-500 flex-shrink-0">統一編號:</span><input type="text" id="clientTax" class="w-full border-b border-gray-300 px-2"></div>
            </div>
        </div>

        <table class="w-full mb-4 text-left border-collapse text-sm">
            <thead>
                <tr class="bg-gray-800 text-white">
                    <th class="p-3 rounded-l-md">類別 / 項目</th>
                    <th class="p-3 w-20 text-center">數量</th>
                    <th class="p-3 w-32 text-center">單價</th>
                    <th class="p-3 w-32 text-center">金額</th>
                    <th class="p-3 w-12 no-print"></th>
                </tr>
            </thead>
            <tbody id="item-list"></tbody>
        </table>
        <button type="button" onclick="addItem()" id="addBtn" class="no-print mb-4 inline-flex items-center text-blue-600 font-bold text-sm">+ 新增報價項目</button>

        <div class="flex justify-end mb-6 text-right">
            <div class="w-64 border-t-2 border-gray-800 pt-2">
                <span class="text-sm text-gray-600 block">總計金額 (含稅)</span>
                <span id="grandTotal" class="font-bold text-2xl text-blue-700">0</span>
            </div>
        </div>

        <div class="mb-6 bg-gray-50 p-4 rounded-lg border-l-4 border-gray-300">
            <h4 class="font-bold text-gray-700 mb-1 text-sm underline">報價備註說明 (Notes)</h4>
            <textarea id="quoteNote" oninput="autoHeight(this)" class="w-full bg-transparent outline-none text-gray-600" placeholder="請輸入備註..."></textarea>
        </div>

        <div class="grid grid-cols-2 gap-8">
            <div class="border border-gray-300 rounded p-4 min-h-[160px] flex flex-col justify-between italic text-gray-400 text-center">
                <p class="font-bold text-sm text-blue-600 not-italic">大腦行銷簽章區</p>
                請蓋公司章或簽名
                <div class="text-xs pt-1 border-t border-dashed text-right not-italic">日期：2026 / &nbsp;&nbsp;&nbsp; / </div>
            </div>
            <div class="border border-gray-300 rounded p-4 min-h-[160px] flex flex-col justify-between">
                <div class="flex justify-between items-center"><p class="font-bold text-sm">客戶簽名處</p><button type="button" onclick="clearSignature()" class="no-print text-xs text-red-500">清除</button></div>
                <div class="signature-wrapper"><canvas id="signature-pad"></canvas></div>
                <div class="text-xs text-gray-400 pt-1 border-t border-dashed text-right">日期：2026 / &nbsp;&nbsp;&nbsp; / </div>
            </div>
        </div>
    </div>

    <div class="max-w-4xl mx-auto mt-6 flex gap-3 justify-center no-print flex-wrap">
        <button onclick="handlePrint()" class="bg-gray-800 text-white font-bold py-3 px-8 rounded shadow">列印 / PDF</button>
        <button onclick="saveToNotion()" id="saveBtn" class="bg-blue-600 text-white font-bold py-3 px-8 rounded shadow">儲存至 Notion</button>
        <button onclick="generateClientLink()" id="linkBtn" class="bg-green-600 text-white font-bold py-3 px-6 rounded shadow">生成客戶專屬連結</button>
    </div>

    <script>
        const canvas = document.getElementById('signature-pad');
        const signaturePad = new SignaturePad(canvas, { backgroundColor: 'rgba(255, 255, 255, 0)', penColor: 'rgb(0, 0, 0)' });

        function resizeCanvas() {
            const ratio = Math.max(window.devicePixelRatio || 1, 1);
            canvas.width = canvas.offsetWidth * ratio;
            canvas.height = canvas.offsetHeight * ratio;
            canvas.getContext("2d").scale(ratio, ratio);
        }

        window.onload = function() {
            document.getElementById('currentDate').valueAsDate = new Date();
            resizeCanvas();

            const p = new URLSearchParams(window.location.search);
            
            // 核心修正：還原項目列表
            if (p.has('items')) {
                try {
                    const itemsData = JSON.parse(decodeURIComponent(p.get('items')));
                    if (Array.isArray(itemsData) && itemsData.length > 0) {
                        itemsData.forEach(item => {
                            addItem(item.n, item.q, item.p);
                        });
                    } else { addItem(); }
                } catch (e) { console.error("解析失敗", e); addItem(); }
            } else {
                addItem();
            }

            // 還原其他欄位
            if(p.get('c')) document.getElementById('clientName').value = p.get('c');
            if(p.get('w')) document.getElementById('clientWeb').value = p.get('w');
            if(p.get('p')) document.getElementById('clientPhone').value = p.get('p');
            if(p.get('t')) document.getElementById('clientTax').value = p.get('t');
            if(p.get('i')) document.getElementById('quoteId').value = p.get('i');
            if(p.get('n')) {
                document.getElementById('quoteNote').value = p.get('n');
                autoHeight(document.getElementById('quoteNote'));
            }

            calculate();

            if (p.get('lock') === '1') {
                document.querySelectorAll('input, textarea').forEach(el => el.readOnly = true);
                document.getElementById('addBtn').style.display = 'none';
                document.getElementById('linkBtn').style.display = 'none';
                document.querySelectorAll('#item-list button').forEach(b => b.style.display='none');
            }
        };

        function addItem(name = "", qty = 1, price = 0) {
            const list = document.getElementById('item-list');
            const row = document.createElement('tr');
            row.className = "border-b border-gray-100";
            row.innerHTML = `
                <td class="p-2"><input type="text" value="${name}" placeholder="項目說明" class="name-input w-full outline-none bg-transparent"></td>
                <td class="p-2 text-center"><input type="number" value="${qty}" class="qty-input w-full text-center outline-none bg-transparent" oninput="calculate()"></td>
                <td class="p-2 text-center"><input type="number" value="${price}" class="price-input w-full text-center outline-none bg-transparent" oninput="calculate()"></td>
                <td class="p-2 text-center font-bold total-cell">0</td>
                <td class="p-2 no-print text-right"><button onclick="removeItem(this)" class="text-red-400 font-bold">✕</button></td>
            `;
            list.appendChild(row);
            calculate();
        }

        function generateClientLink() {
            const items = [];
            document.querySelectorAll('#item-list tr').forEach(row => {
                const name = row.querySelector('.name-input').value;
                const qty = row.querySelector('.qty-input').value;
                const price = row.querySelector('.price-input').value;
                if(name || price > 0) { // 只抓取有填寫的項目
                    items.push({ n: name, q: qty, p: price });
                }
            });

            const baseUrl = window.location.origin + window.location.pathname;
            const params = new URLSearchParams();
            params.set('c', document.getElementById('clientName').value);
            params.set('w', document.getElementById('clientWeb').value);
            params.set('p', document.getElementById('clientPhone').value);
            params.set('t', document.getElementById('clientTax').value);
            params.set('i', document.getElementById('quoteId').value);
            params.set('n', document.getElementById('quoteNote').value);
            params.set('items', JSON.stringify(items)); // 序列化項目
            params.set('lock', '1');

            const fullUrl = `${baseUrl}?${params.toString()}`;
            
            // 執行複製
            navigator.clipboard.writeText(fullUrl).then(() => {
                alert("✅ 客戶專屬連結已複製！請貼上傳送給客戶。");
                console.log("Generated URL:", fullUrl);
            }).catch(err => {
                alert("複製失敗，請手動從控制台(F12)複製網址");
            });
        }

        function clearSignature() { signaturePad.clear(); }
        function autoHeight(el) { el.style.height = "auto"; el.style.height = (el.scrollHeight) + "px"; }
        function removeItem(btn) { btn.closest('tr').remove(); calculate(); }
        function calculate() {
            let s = 0;
            document.querySelectorAll('#item-list tr').forEach(r => {
                const q = parseFloat(r.querySelector('.qty-input').value) || 0;
                const p = parseFloat(r.querySelector('.price-input').value) || 0;
                const t = q * p;
                r.querySelector('.total-cell').innerText = t.toLocaleString();
                s += t;
            });
            document.getElementById('grandTotal').innerText = Math.round(s * 1.05).toLocaleString();
        }
        function handlePrint() {
            document.title = `${document.getElementById('clientName').value}-${document.getElementById('currentDate').value}-${document.getElementById('quoteId').value}`;
            window.print();
        }
        async function saveToNotion() {
            const btn = document.getElementById('saveBtn');
            btn.innerText = "儲存中..."; btn.disabled = true;
            try {
                const res = await fetch("https://eo2ddbgd6zenms9.m.pipedream.net", {
                    method: 'POST', headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        company: document.getElementById('clientName').value,
                        date: document.getElementById('currentDate').value,
                        total: parseInt(document.getElementById('grandTotal').innerText.replace(/,/g, '')),
                        id: document.getElementById('quoteId').value,
                        note: document.getElementById('quoteNote').value
                    })
                });
                if (res.ok) alert('✅ 儲存成功！');
            } catch (e) { alert('❌ 失敗'); } finally { btn.innerText = "儲存至 Notion"; btn.disabled = false; }
        }
    </script>
</body>
</html>

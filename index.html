<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>大腦行銷 - 專業報價系統</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/signature_pad@4.1.7/dist/signature_pad.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
    <style>
        body { font-size: 0.95rem; } 
        input, textarea { font-size: 0.9rem; border-radius: 4px; }
        #quoteNote { font-size: 0.85rem; line-height: 1.5; overflow-y: hidden; resize: none; min-height: 80px; width: 100%; display: block; }
        
        /* 簽名板樣式 */
        .signature-wrapper { border: 1px solid #e2e8f0; background-color: #f8fafc; border-radius: 0.375rem; position: relative; width: 100%; height: 160px; }
        canvas { width: 100%; height: 100%; touch-action: none; }

        /* 手機版 RWD 調整 */
        @media (max-width: 640px) {
            .invoice-container { padding: 1.5rem !important; }
            .signature-grid { grid-template-columns: 1fr !important; }
            .signature-wrapper { height: 200px; } /* 手機版簽名區加高，方便手指書寫 */
        }

        @media print {
            @page { size: A4; margin: 0.8cm; }
            html, body { zoom: 92%; height: auto; }
            .no-print { display: none !important; }
            body { padding: 0; background: white; }
            .shadow-lg { box-shadow: none !important; border: 1px solid #eee; }
            input, textarea { border: none !important; background: transparent !important; }
        }
    </style>
</head>
<body class="bg-gray-100 p-2 md:p-6">

    <div class="max-w-4xl mx-auto bg-white p-6 md:p-10 shadow-lg rounded-lg border border-gray-200 invoice-container" id="invoice">
        <div class="flex flex-col md:flex-row justify-between items-start border-b-4 border-gray-800 pb-4 mb-6">
            <div>
                <h1 class="text-4xl font-extrabold text-gray-800">報價單</h1>
                <h2 class="text-xl font-bold text-blue-600 mt-1">大腦行銷</h2>
            </div>
            <div class="text-left md:text-right space-y-1 text-sm mt-4 md:mt-0">
                <p class="text-gray-600">報價日期：<input type="date" id="currentDate" class="outline-none border-b border-gray-200"></p>
                <p class="text-gray-600">報價編號：<input type="text" id="quoteId" placeholder="QT-20260204" class="outline-none md:text-right border-b border-gray-200 w-32"></p>
            </div>
        </div>

        <div class="mb-6">
            <h3 class="font-bold text-gray-700 mb-2 border-l-4 border-blue-500 pl-2 text-base">客戶資訊</h3>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-x-6 gap-y-2 text-sm">
                <div class="flex items-center"><span class="w-20 text-gray-500 flex-shrink-0">公司名稱:</span><input type="text" id="clientName" class="w-full border-b border-gray-300 px-2"></div>
                <div class="flex items-center"><span class="w-20 text-gray-500 flex-shrink-0">官方網域:</span><input type="text" id="clientWeb" class="w-full border-b border-gray-300 px-2"></div>
                <div class="flex items-center"><span class="w-20 text-gray-500 flex-shrink-0">連絡電話:</span><input type="text" id="clientPhone" class="w-full border-b border-gray-300 px-2"></div>
                <div class="flex items-center"><span class="w-20 text-gray-500 flex-shrink-0">統一編號:</span><input type="text" id="clientTax" class="w-full border-b border-gray-300 px-2"></div>
            </div>
        </div>

        <div class="overflow-x-auto">
            <table class="w-full mb-4 text-left border-collapse text-sm min-w-[500px] md:min-w-0">
                <thead>
                    <tr class="bg-gray-800 text-white">
                        <th class="p-3 rounded-l-md">類別 / 項目</th>
                        <th class="p-3 w-16 text-center">數量</th>
                        <th class="p-3 w-28 text-center">單價</th>
                        <th class="p-3 w-28 text-center">金額</th>
                        <th class="p-3 w-10 no-print"></th>
                    </tr>
                </thead>
                <tbody id="item-list"></tbody>
            </table>
        </div>
        <button type="button" onclick="addItem()" id="addBtn" class="no-print mb-4 inline-flex items-center text-blue-600 font-bold text-sm hover:text-blue-800">
            <span class="text-lg mr-1">+</span> 新增報價項目
        </button>

        <div class="flex justify-end mb-6 text-right">
            <div class="w-full md:w-64 border-t-2 border-gray-800 pt-2">
                <span class="text-sm text-gray-600 block">總計金額 (含稅)</span>
                <span id="grandTotal" class="font-bold text-2xl text-blue-700">0</span>
            </div>
        </div>

        <div class="mb-6 bg-gray-50 p-4 rounded-lg border-l-4 border-gray-300">
            <h4 class="font-bold text-gray-700 mb-1 text-sm underline">報價備註說明 (Notes)</h4>
            <textarea id="quoteNote" oninput="autoHeight(this)" class="w-full bg-transparent outline-none text-gray-600" placeholder="請輸入備註..."></textarea>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 signature-grid">
            <div class="border border-gray-300 rounded p-4 min-h-[160px] flex flex-col justify-between italic text-gray-400 text-center bg-gray-50/50">
                <p class="font-bold text-sm text-blue-600 not-italic">大腦行銷簽章區</p>
                請蓋公司章或簽名
                <div class="text-xs pt-1 border-t border-dashed text-right not-italic">日期：2026 / &nbsp;&nbsp;&nbsp; / </div>
            </div>
            <div class="border border-gray-300 rounded p-4 min-h-[160px] flex flex-col justify-between">
                <div class="flex justify-between items-center"><p class="font-bold text-sm">客戶簽名處</p><button type="button" onclick="clearSignature()" class="no-print text-xs text-red-500">清除</button></div>
                <div class="signature-wrapper"><canvas id="signature-pad"></canvas></div>
                <div class="text-xs text-gray-400 pt-1 border-t border-dashed text-right">日期：2026 / &nbsp;&nbsp;&nbsp; / </div>
            </div>
        </div>
    </div>

    <div class="max-w-4xl mx-auto mt-6 flex gap-3 justify-center no-print flex-wrap px-4 pb-10">
        <button onclick="handlePrint()" class="bg-gray-800 text-white font-bold py-3 px-6 rounded shadow text-sm">下載 PDF</button>
        <button onclick="saveAsImage()" class="bg-orange-500 text-white font-bold py-3 px-6 rounded shadow text-sm">存為 PNG (回傳用)</button>
        <button onclick="saveToNotion()" id="saveBtn" class="bg-blue-600 text-white font-bold py-3 px-6 rounded shadow text-sm">儲存至 Notion</button>
        <button onclick="generateClientLink()" id="linkBtn" class="bg-green-600 text-white font-bold py-3 px-6 rounded shadow text-sm">生成客戶連結</button>
    </div>

    <script>
        const canvas = document.getElementById('signature-pad');
        const signaturePad = new SignaturePad(canvas, { backgroundColor: 'rgba(255, 255, 255, 0)', penColor: 'rgb(0, 0, 0)' });

        function resizeCanvas() {
            const ratio = Math.max(window.devicePixelRatio || 1, 1);
            const container = canvas.parentElement;
            canvas.width = container.offsetWidth * ratio;
            canvas.height = container.offsetHeight * ratio;
            canvas.getContext("2d").scale(ratio, ratio);
            signaturePad.clear();
        }

        window.onload = function() {
            document.getElementById('currentDate').valueAsDate = new Date();
            resizeCanvas();
            const p = new URLSearchParams(window.location.search);
            
            // 還原資料
            if (p.has('items')) {
                try {
                    const itemsData = JSON.parse(decodeURIComponent(p.get('items')));
                    itemsData.forEach(item => addItem(item.n, item.q, item.p));
                } catch (e) { addItem(); }
            } else { addItem(); }
            if(p.get('c')) document.getElementById('clientName').value = p.get('c');
            if(p.get('w')) document.getElementById('clientWeb').value = p.get('w');
            if(p.get('p')) document.getElementById('clientPhone').value = p.get('p');
            if(p.get('t')) document.getElementById('clientTax').value = p.get('t');
            if(p.get('i')) document.getElementById('quoteId').value = p.get('i');
            if(p.get('n')) { document.getElementById('quoteNote').value = p.get('n'); autoHeight(document.getElementById('quoteNote')); }
            
            calculate();

            // 客戶端判定 (lock=1)
            if (p.get('lock') === '1') {
                document.querySelectorAll('input, textarea').forEach(el => el.readOnly = true);
                document.getElementById('addBtn').style.display = 'none';
                document.getElementById('linkBtn').style.display = 'none';
                document.getElementById('saveBtn').style.display = 'none'; // 客戶端隱藏 Notion 按鈕
                document.querySelectorAll('#item-list button').forEach(b => b.style.display='none');
            }
        };

        function saveAsImage() {
    const name = document.getElementById('clientName').value || "客戶";
    const date = document.getElementById('currentDate').value;
    const id = document.getElementById('quoteId').value || "無編號";
    const fileName = `${name}-${date}-${id}.png`;
    
    // 顯示讀取中，避免手機版沒反應
    const btn = event.target;
    const originalText = btn.innerText;
    btn.innerText = "產生圖片中...";
    btn.disabled = true;

    // 針對手機優化設定
    html2canvas(document.getElementById('invoice'), { 
        scale: 2,           // 2 倍解析度，兼顧清晰度與手機性能
        useCORS: true,      // 允許跨域圖片
        logging: false,     // 關閉日誌
        backgroundColor: "#FFFFFF" // 確保背景是白色而非透明
    }).then(canvas => {
        try {
            // 嘗試自動下載
            const link = document.createElement('a');
            link.download = fileName;
            link.href = canvas.toDataURL("image/png");
            
            // 判斷是否為 iOS 或某些行動裝置
            const isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);
            
            if (isMobile) {
                // 手機版：直接在新分頁開啟圖片，讓客戶長按圖片儲存
                const imgData = canvas.toDataURL("image/png");
                const newTab = window.open();
                if (newTab) {
                    newTab.document.write(`<img src="${imgData}" style="width:100%" />`);
                    newTab.document.title = fileName;
                    alert("✅ 圖片已產生！請在開啟的新視窗中「長按圖片」選擇「儲存圖片」，再回傳即可。");
                } else {
                    alert("❌ 偵測到彈出視窗被阻擋，請手動允許或嘗試列印 PDF。");
                }
            } else {
                // 電腦版：直接下載
                link.click();
            }
        } catch (err) {
            console.error("PNG 產生失敗:", err);
            alert("❌ 圖片產生失敗，建議改用「下載 PDF」功能。");
        } finally {
            btn.innerText = originalText;
            btn.disabled = false;
        }
    });
}

        function addItem(name = "", qty = 1, price = 0) {
            const list = document.getElementById('item-list');
            const row = document.createElement('tr');
            row.className = "border-b border-gray-100";
            row.innerHTML = `<td class="p-2"><input type="text" value="${name}" class="name-input w-full outline-none bg-transparent"></td><td class="p-2 text-center"><input type="number" value="${qty}" class="qty-input w-full text-center outline-none bg-transparent" oninput="calculate()"></td><td class="p-2 text-center"><input type="number" value="${price}" class="price-input w-full text-center outline-none bg-transparent" oninput="calculate()"></td><td class="p-2 text-center font-bold total-cell text-gray-700">0</td><td class="p-2 no-print text-right"><button onclick="removeItem(this)" class="text-red-400 font-bold">✕</button></td>`;
            list.appendChild(row);
            calculate();
        }

        function calculate() {
            let s = 0;
            document.querySelectorAll('#item-list tr').forEach(r => {
                const q = parseFloat(r.querySelector('.qty-input').value) || 0;
                const p = parseFloat(r.querySelector('.price-input').value) || 0;
                const t = q * p;
                r.querySelector('.total-cell').innerText = t.toLocaleString();
                s += t;
            });
            document.getElementById('grandTotal').innerText = Math.round(s * 1.05).toLocaleString();
        }

        function generateClientLink() {
            const items = [];
            document.querySelectorAll('#item-list tr').forEach(row => {
                items.push({ n: row.querySelector('.name-input').value, q: row.querySelector('.qty-input').value, p: row.querySelector('.price-input').value });
            });
            const p = new URLSearchParams({
                c: document.getElementById('clientName').value,
                w: document.getElementById('clientWeb').value,
                p: document.getElementById('clientPhone').value,
                t: document.getElementById('clientTax').value,
                i: document.getElementById('quoteId').value,
                n: document.getElementById('quoteNote').value,
                items: JSON.stringify(items),
                lock: 1
            });
            navigator.clipboard.writeText(`${window.location.origin + window.location.pathname}?${p.toString()}`).then(() => alert("專屬連結已複製！傳給客戶後，他們無法修改內容，且無法存入你的 Notion。"));
        }

        function clearSignature() { signaturePad.clear(); }
        function removeItem(btn) { btn.closest('tr').remove(); calculate(); }
        function autoHeight(el) { el.style.height = "auto"; el.style.height = (el.scrollHeight) + "px"; }
        function handlePrint() { 
            document.title = `${document.getElementById('clientName').value}-${document.getElementById('currentDate').value}-${document.getElementById('quoteId').value}`;
            window.print(); 
        }

        async function saveToNotion() {
            const btn = document.getElementById('saveBtn');
            btn.innerText = "儲存中..."; btn.disabled = true;
            try {
                const res = await fetch("https://eo2ddbgd6zenms9.m.pipedream.net", {
                    method: 'POST', headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        company: document.getElementById('clientName').value,
                        date: document.getElementById('currentDate').value,
                        total: parseInt(document.getElementById('grandTotal').innerText.replace(/,/g, '')),
                        id: document.getElementById('quoteId').value,
                        note: document.getElementById('quoteNote').value
                    })
                });
                if (res.ok) alert('✅ 已成功儲存至你的 Notion！');
            } catch (e) { alert('❌ 儲存失敗'); } finally { btn.innerText = "儲存至 Notion"; btn.disabled = false; }
        }
    </script>
</body>
</html>

